{% extends "login_main/base/base.html" %} {% block content %}
<div class="max-w-7xl mx-auto">
  <!-- Page Header -->
  <div
    class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6"
  >
    <div>
      <h2 class="text-2xl font-bold text-gray-800 flex items-center">
        <i class="fas fa-user-injured mr-2 text-primary"></i>
        Patient Management
      </h2>
      <p class="text-sm text-gray-500 mt-1">
        View and manage all patient records
      </p>
    </div>
    <a
      href="{% url 'AddPatient' %}"
      class="mt-4 md:mt-0 px-4 py-2 bg-primary hover:bg-primary-dark text-black rounded-lg font-medium flex items-center"
    >
      <i class="fas fa-plus mr-2"></i> Add New Patient
    </a>
  </div>
  {% if messages %}
  <div class="fixed top-5 right-5 z-50 space-y-2 max-w-sm w-full">
    {% for message in messages %}
    <div
      class="px-4 py-3 rounded-lg shadow-lg text-sm font-medium {% if message.tags == 'success' %} bg-green-100 text-green-800 border border-green-300 {% elif message.tags == 'error' %} bg-red-100 text-red-800 border border-red-300 {% elif message.tags == 'warning' %} bg-yellow-100 text-yellow-800 border border-yellow-300 {% else %} bg-blue-100 text-blue-800 border border-blue-300 {% endif %}"
    >
      {{ message }}
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Patient Search and Filters -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6">
    <form method="GET" id="search-form">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <!-- Search -->
        <div class="md:col-span-2">
          <div class="relative">
            <input
              type="text"
              name="search"
              id="search-input"
              placeholder="Search patients by name, ID, phone, or email..."
              value="{{ search_query }}"
              class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-primary outline-none"
            />
            <i class="fas fa-search absolute left-3 top-2.5 text-gray-400"></i>
            
            <!-- Search suggestions dropdown -->
            <div id="search-suggestions" class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto">
              <!-- Dynamic search results will appear here -->
            </div>
          </div>
        </div>

        <!-- Status Filter -->
        <div>
          <select
            name="status"
            id="status-filter"
            class="w-full pl-3 pr-10 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none appearance-none"
          >
            <option value="">All Statuses</option>
            <option value="SCHEDULED" {% if status_filter == 'SCHEDULED' %}selected{% endif %}>SCHEDULED</option>
            <option value="COMPLETED" {% if status_filter == 'COMPLETED' %}selected{% endif %}>COMPLETED</option>
            <option value="CANCELLED" {% if status_filter == 'CANCELLED' %}selected{% endif %}>CANCELLED</option>
            <option value="RESCHEDULED" {% if status_filter == 'RESCHEDULED' %}selected{% endif %}>RESCHEDULED</option>
            <option value="PENDING" {% if status_filter == 'PENDING' %}selected{% endif %}>PENDING</option>
          </select>
        </div>   

        <!-- Date Filter -->
        <div>
          <select
            name="date_range"
            id="date-filter"
            class="w-full pl-3 pr-10 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none appearance-none"
          >
            <option value="">All Time</option>
            <option value="today" {% if date_filter == 'today' %}selected{% endif %}>Today</option>
            <option value="week" {% if date_filter == 'week' %}selected{% endif %}>This Week</option>
            <option value="month" {% if date_filter == 'month' %}selected{% endif %}>This Month</option>
            <option value="year" {% if date_filter == 'year' %}selected{% endif %}>This Year</option>
          </select>
        </div>
      </div>
      
      <!-- Search Results Info -->
      {% if search_query or status_filter or date_filter %}
      <div class="mt-3 flex items-center justify-between">
        <div class="text-sm text-gray-600">
          {% if search_query %}
            Showing results for "<strong>{{ search_query }}</strong>"
          {% endif %}
          {% if status_filter %}
            | Status: <strong>{{ status_filter }}</strong>
          {% endif %}
          {% if date_filter %}
            | Date: <strong>{{ date_filter|title }}</strong>
          {% endif %}
        </div>
        <a href="{% url 'Patients' %}" class="text-sm text-primary hover:underline">Clear filters</a>
      </div>
      {% endif %}
    </form>
  </div>

  <!-- Patient Statistics Cards -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-500">Total Patients</p>
          <p class="text-2xl font-bold mt-1">{{total_patients}}</p>
        </div>
        <div class="bg-primary-light p-3 rounded-full">
          <i class="fas fa-users text-primary text-xl"></i>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-500">New This Month</p>
          <p class="text-2xl font-bold mt-1">{{new_this_month}}</p>
        </div>
        <div class="bg-green-100 p-3 rounded-full">
          <i class="fas fa-user-plus text-green-600 text-xl"></i>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-500">Upcoming Appointments</p>
          <p class="text-2xl font-bold mt-1">{{upcoming_appointments}}</p>
        </div>
        <div class="bg-blue-100 p-3 rounded-full">
          <i class="fas fa-calendar-check text-blue-600 text-xl"></i>
        </div>
      </div>
    </div>

  </div>

  <!-- Patient Table -->
  <div
    class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden"
  >
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th
              scope="col"
              class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Patient ID
            </th>
            <th
              scope="col"
              class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Name
            </th>
            <th
              scope="col"
              class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Contact
            </th>
            <th
              scope="col"
              class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Last Visit
            </th>
            <th
              scope="col"
              class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Status
            </th>
            <th
              scope="col"
              class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Actions
            </th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          {% if page_obj %}
           {% for patient in page_obj %}
          <tr class="hover:bg-gray-50">
            <td
              class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900"
            >
              <div class="flex items-center space-x-2">
                <span id="patient-id-{{forloop.counter}}">{{patient.hospital_patient_id}}</span>
                <button 
                  onclick="copyPatientId('{{patient.hospital_patient_id}}', {{forloop.counter}})"
                  class="text-gray-400 hover:text-primary transition-colors duration-200 p-1 rounded hover:bg-gray-100"
                  title="Copy Patient ID"
                >
                  <i class="fas fa-copy text-xs"></i>
                </button>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <div class="flex-shrink-0 h-10 w-10">
                  <img
                    class="h-10 w-10 rounded-full"
                    src="https://ui-avatars.com/api/?name=John+Doe&background=ecfeff&color=0e7490"
                    alt=""
                  />
                </div>
                <div class="ml-4">
                  <div class="text-sm font-medium text-gray-900">{{patient.first_name}} {{patient.last_name}}</div>
                  <div class="text-sm text-gray-500">{{patient.gender}}, {{patient.date_of_birth}}</div>
                </div>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              {{patient.email}}<br />
              {{patient.phone_number}}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              {{patient.last_visit_date}}<br />
              <span class="text-xs text-primary">{{patient.reason}}</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span
                class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800"
              >
                {{patient.status}}
              </span>
            </td>
            <td
              class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"
            >
              <div class="flex justify-end space-x-2">
                <a href="#" class="text-primary hover:text-primary-dark">
                  <i class="fas fa-eye"></i>
                </a>
                <a href="#" class="text-blue-600 hover:text-blue-800">
                  <i class="fas fa-edit"></i>
                </a>
                <a href="{% url 'DeletePatient' patient.hospital_patient_id %}" class="text-red-600 hover:text-red-800">
                  <i class="fas fa-trash-alt"></i>
                </a>
              </div>
            </td>
          </tr>
           {% endfor %}
          {% else %}
          <tr>
            <td colspan="6" class="px-6 py-8 text-center">
              <div class="flex flex-col items-center">
                <i class="fas fa-search text-4xl text-gray-300 mb-3"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-1">No patients found</h3>
                <p class="text-gray-500">
                  {% if search_query %}
                    No patients match your search for "{{ search_query }}"
                  {% else %}
                    No patients match your current filters
                  {% endif %}
                </p>
                <a href="{% url 'Patients' %}" class="mt-3 text-primary hover:underline">Clear all filters</a>
              </div>
            </td>
          </tr>
          {% endif %}
          
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
        <div class="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
            <p class="text-sm text-gray-700">
                Showing 
                <span class="font-medium">{{ page_obj.start_index }}</span> 
                to 
                <span class="font-medium">{{ page_obj.end_index }}</span> 
                of 
                <span class="font-medium">{{ page_obj.paginator.count }}</span> patients
            </p>
            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                
                {% if page_obj.has_previous %}
                    <a href="?page={{ page_obj.previous_page_number }}" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                {% endif %}
            

                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                        <span class="z-10 bg-primary-light border-primary text-primary relative inline-flex items-center px-4 py-2 border text-sm font-medium">{{ num }}</span>
                    {% else %}
                        <a href="?page={{ num }}" class="bg-white border-gray-300 text-gray-500 hover:bg-gray-50 relative inline-flex items-center px-4 py-2 border text-sm font-medium">{{ num }}</a>
                    {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                {% endif %}
               
            </nav>
        </div>
    </div>
  </div>
</div>

{% endblock content %} {% block scripts %}

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById('search-input');
    const searchSuggestions = document.getElementById('search-suggestions');
    const searchForm = document.getElementById('search-form');
    const statusFilter = document.getElementById('status-filter');
    const dateFilter = document.getElementById('date-filter');
    
    let searchTimeout;
    
    // Real-time search suggestions
    searchInput.addEventListener('input', function(e) {
      const query = e.target.value.trim();
      
      clearTimeout(searchTimeout);
      
      if (query.length >= 2) {
        searchTimeout = setTimeout(() => {
          fetch(`/search-patients-ajax/?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
              displaySearchSuggestions(data);
            })
            .catch(error => {
              console.error('Search error:', error);
              searchSuggestions.classList.add('hidden');
            });
        }, 300);
      } else {
        searchSuggestions.classList.add('hidden');
      }
    });
    
    // Display search suggestions
    function displaySearchSuggestions(patients) {
      if (patients.length === 0) {
        searchSuggestions.innerHTML = '<div class="p-3 text-gray-500 text-sm">No patients found</div>';
        searchSuggestions.classList.remove('hidden');
        return;
      }
      
      const suggestionsHTML = patients.map(patient => `
        <div class="p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0" 
             onclick="selectPatient('${patient.name}')">
          <div class="flex items-center justify-between">
            <div>
              <div class="font-medium text-gray-900">${patient.name}</div>
              <div class="text-sm text-gray-500">ID: ${patient.id} | ${patient.phone}</div>
            </div>
            <span class="px-2 py-1 text-xs rounded-full bg-${getStatusColor(patient.status)}-100 text-${getStatusColor(patient.status)}-800">
              ${patient.status}
            </span>
          </div>
        </div>
      `).join('');
      
      searchSuggestions.innerHTML = suggestionsHTML;
      searchSuggestions.classList.remove('hidden');
    }
    
    // Select patient from suggestions
    window.selectPatient = function(patientName) {
      searchInput.value = patientName;
      searchSuggestions.classList.add('hidden');
      searchForm.submit();
    };
    
    // Get status color
    function getStatusColor(status) {
      switch(status) {
        case 'SCHEDULED': return 'blue';
        case 'COMPLETED': return 'green';
        case 'CANCELLED': return 'red';
        case 'RESCHEDULED': return 'yellow';
        case 'PENDING': return 'orange';
        default: return 'gray';
      }
    }
    
    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
      if (!searchInput.contains(e.target) && !searchSuggestions.contains(e.target)) {
        searchSuggestions.classList.add('hidden');
      }
    });
    
    // Auto-submit form on filter changes
    statusFilter.addEventListener('change', function() {
      searchForm.submit();
    });
    
    dateFilter.addEventListener('change', function() {
      searchForm.submit();
    });
    
    // Submit form on Enter key
    searchInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        searchSuggestions.classList.add('hidden');
        searchForm.submit();
      }
    });
    
    // Clear search button functionality
    const clearButton = document.querySelector('a[href*="Clear filters"]');
    if (clearButton) {
      clearButton.addEventListener('click', function(e) {
        e.preventDefault();
        searchInput.value = '';
        statusFilter.value = '';
        dateFilter.value = '';
        window.location.href = '{% url "Patients" %}';
      });
    }
  });
  
  // Copy patient ID function
  function copyPatientId(patientId, counter) {
    // Try to use the modern clipboard API first
    if (navigator.clipboard && window.isSecureContext) {
      navigator.clipboard.writeText(patientId).then(function() {
        showCopySuccess(counter);
      }).catch(function(err) {
        // Fallback to older method
        fallbackCopyTextToClipboard(patientId, counter);
      });
    } else {
      // Fallback for older browsers or non-HTTPS
      fallbackCopyTextToClipboard(patientId, counter);
    }
  }
  
  // Fallback copy method for older browsers
  function fallbackCopyTextToClipboard(text, counter) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    textArea.style.top = "0";
    textArea.style.left = "0";
    textArea.style.position = "fixed";
    textArea.style.opacity = "0";
    
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
      const successful = document.execCommand('copy');
      if (successful) {
        showCopySuccess(counter);
      } else {
        showCopyError(counter);
      }
    } catch (err) {
      showCopyError(counter);
    }
    
    document.body.removeChild(textArea);
  }
  
  // Show success feedback
  function showCopySuccess(counter) {
    const button = document.querySelector(`button[onclick*="${counter}"]`);
    const icon = button.querySelector('i');
    const originalClass = icon.className;
    
    // Change icon to checkmark
    icon.className = 'fas fa-check text-xs text-green-600';
    button.classList.add('text-green-600');
    
    // Show tooltip-like message
    const tooltip = document.createElement('div');
    tooltip.className = 'absolute bg-gray-800 text-white text-xs rounded py-1 px-2 -top-8 left-1/2 transform -translate-x-1/2 z-10';
    tooltip.textContent = 'Copied!';
    button.style.position = 'relative';
    button.appendChild(tooltip);
    
    // Reset after 2 seconds
    setTimeout(() => {
      icon.className = originalClass;
      button.classList.remove('text-green-600');
      if (tooltip.parentNode) {
        tooltip.parentNode.removeChild(tooltip);
      }
    }, 2000);
  }
  
  // Show error feedback
  function showCopyError(counter) {
    const button = document.querySelector(`button[onclick*="${counter}"]`);
    const icon = button.querySelector('i');
    const originalClass = icon.className;
    
    // Change icon to error
    icon.className = 'fas fa-times text-xs text-red-600';
    button.classList.add('text-red-600');
    
    // Show error tooltip
    const tooltip = document.createElement('div');
    tooltip.className = 'absolute bg-red-600 text-white text-xs rounded py-1 px-2 -top-8 left-1/2 transform -translate-x-1/2 z-10';
    tooltip.textContent = 'Copy failed';
    button.style.position = 'relative';
    button.appendChild(tooltip);
    
    // Reset after 2 seconds
    setTimeout(() => {
      icon.className = originalClass;
      button.classList.remove('text-red-600');
      if (tooltip.parentNode) {
        tooltip.parentNode.removeChild(tooltip);
      }
    }, 2000);
  }
</script>
{% endblock scripts %}
